<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Presentkort - Restaurang Viola</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #3e0f15;
            color: #F8EAD7;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
            padding: 3rem 1.5rem;
            text-align: center;
        }

        .logo {
            display: block;
            margin-bottom: 2.5rem;
        }

        .logo img {
            width: 140px;
            filter: brightness(0) invert(1) opacity(0.9);
        }

        .card {
            background: rgba(248, 234, 215, 0.05);
            border: 1px solid rgba(248, 234, 215, 0.1);
            padding: 2rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            opacity: 0.5;
            margin-bottom: 0.5rem;
        }

        .card-balance {
            font-family: 'Fraunces', serif;
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .card-original {
            font-size: 0.8rem;
            opacity: 0.4;
            margin-bottom: 1.5rem;
        }

        .card-status {
            display: inline-block;
            padding: 0.3rem 1rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .card-status.active {
            background: rgba(46, 125, 50, 0.2);
            color: #81c784;
        }

        .card-status.redeemed {
            background: rgba(198, 40, 40, 0.2);
            color: #ef9a9a;
        }

        .card-status.expired {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(248, 234, 215, 0.5);
        }

        .card-code {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            letter-spacing: 0.1em;
            background: rgba(248, 234, 215, 0.08);
            padding: 0.6rem 1rem;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .card-details {
            border-top: 1px solid rgba(248, 234, 215, 0.1);
            padding-top: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.3rem 0;
        }

        .detail-row .label {
            opacity: 0.4;
        }

        .loading, .not-found {
            padding: 3rem 0;
        }

        .loading {
            opacity: 0.5;
            font-size: 0.85rem;
        }

        .not-found h2 {
            font-family: 'Fraunces', serif;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .not-found p {
            font-size: 0.85rem;
            opacity: 0.5;
        }

        .restaurant-info {
            font-size: 0.75rem;
            opacity: 0.3;
            line-height: 1.6;
            margin-top: 1rem;
        }

        .restaurant-info a {
            color: #F8EAD7;
        }

        .back-link {
            margin-top: 2rem;
        }

        .back-link a {
            color: #F8EAD7;
            opacity: 0.4;
            text-decoration: none;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: opacity 0.2s;
        }

        .back-link a:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <a class="logo" href="index.html">
            <img src="Viola_Burgundy.svg" alt="Viola">
        </a>

        <div id="loading" class="loading">Hämtar presentkort...</div>

        <div id="not-found" style="display:none;" class="not-found">
            <h2>Hittades inte</h2>
            <p>Inget presentkort med den koden kunde hittas.</p>
        </div>

        <div id="gift-card" style="display:none;">
            <div class="card">
                <div class="card-label">Saldo</div>
                <div class="card-balance" id="balance"></div>
                <div class="card-original" id="original"></div>
                <span class="card-status" id="status"></span>
                <div class="card-code" id="code"></div>
                <div class="card-details">
                    <div class="detail-row">
                        <span class="label">Mottagare</span>
                        <span id="recipient"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Giltig till</span>
                        <span id="expires"></span>
                    </div>
                </div>
            </div>

            <p class="restaurant-info">
                Restaurang Viola<br>
                <a href="https://maps.google.com/?q=Posthusgatan+1C,+761+30+Norrtälje" target="_blank">
                    Posthusgatan 1C, 761 30 Norrtälje
                </a><br>
                Tisdag – Fredag 16:30 – 23:00
            </p>
        </div>

        <div class="back-link" id="admin-link" style="display:none;">
            <a id="admin-href" href="admin.html">Lös in presentkort &rarr;</a>
        </div>

        <div class="back-link">
            <a href="index.html">&larr; restaurangviola.se</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nssyzyjtmhlriyilgddf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3l6eWp0bWhscml5aWxnZGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Mzc4NzYsImV4cCI6MjA4NjQxMzg3Nn0.D-kA6ibSUlGtawOeetGDrvDB8xBN9gFXiA6EmiyfoeQ';

        const code = new URLSearchParams(window.location.search).get('code');

        if (!code) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('not-found').style.display = 'block';
        } else {
            lookup(code);
        }

        async function lookup(code) {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/gift_cards?code=eq.${encodeURIComponent(code.toUpperCase())}&select=*`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                const cards = await res.json();

                document.getElementById('loading').style.display = 'none';

                if (!cards.length) {
                    document.getElementById('not-found').style.display = 'block';
                    return;
                }

                const card = cards[0];

                document.getElementById('balance').textContent = card.balance + ' kr';
                document.getElementById('original').textContent =
                    card.balance < card.amount ? 'Ursprungligt belopp: ' + card.amount + ' kr' : '';
                document.getElementById('code').textContent = card.code;
                document.getElementById('recipient').textContent = card.recipient_name;
                document.getElementById('expires').textContent = new Date(card.expires_at).toLocaleDateString('sv-SE');

                const statusEl = document.getElementById('status');
                statusEl.className = 'card-status ' + card.status;
                statusEl.textContent = card.status === 'active' ? 'Aktivt'
                    : card.status === 'redeemed' ? 'Förbrukat' : 'Utgånget';

                document.getElementById('gift-card').style.display = 'block';
                document.getElementById('admin-link').style.display = 'block';
                document.getElementById('admin-href').href = 'admin.html?code=' + encodeURIComponent(card.code);
            } catch (err) {
                console.error(err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('not-found').style.display = 'block';
            }
        }
    </script>
</body>
</html>
