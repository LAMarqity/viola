<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Presentkort - Restaurang Viola</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #3e0f15;
            color: #F8EAD7;
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .logo {
            display: block;
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo img {
            width: 140px;
            filter: brightness(0) invert(1) opacity(0.9);
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.7;
            line-height: 1.6;
            margin-bottom: 2.5rem;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(248, 234, 215, 0.2);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: #F8EAD7;
            width: 24px;
            border-radius: 4px;
        }

        /* Sections */
        .step { display: none; }
        .step.active { display: block; }

        .amount-label {
            display: block;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .amount-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .amount-btn {
            padding: 1rem;
            border: 1px solid rgba(248, 234, 215, 0.25);
            background: transparent;
            color: #F8EAD7;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .amount-btn:hover {
            border-color: #F8EAD7;
            background: rgba(248, 234, 215, 0.08);
        }

        .amount-btn.selected {
            background: #F8EAD7;
            color: #3e0f15;
            border-color: #F8EAD7;
        }

        .custom-amount-input {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 1px solid rgba(248, 234, 215, 0.25);
            background: transparent;
            color: #F8EAD7;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            text-align: center;
            margin-top: 0.5rem;
        }

        .custom-amount-input::placeholder {
            color: rgba(248, 234, 215, 0.4);
        }

        .custom-amount-input:focus {
            outline: none;
            border-color: #F8EAD7;
        }

        .section-divider {
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            font-size: 0.7rem;
            opacity: 0.4;
            margin: 2rem 0 1rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        label {
            display: block;
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            font-size: 0.8rem;
        }

        label .optional {
            opacity: 0.4;
            text-transform: none;
            letter-spacing: normal;
            font-size: 0.75rem;
        }

        input, textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: none;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: rgba(248, 234, 215, 0.1);
            color: #F8EAD7;
        }

        input:focus, textarea:focus {
            outline: none;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(248, 234, 215, 0.4);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            background: #F8EAD7;
            color: #3e0f15;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            margin-top: 1.5rem;
            transition: background-color 0.2s;
        }

        .submit-btn:hover:not(:disabled) {
            background: #ffffff;
        }

        .submit-btn:disabled {
            cursor: default;
            opacity: 0.7;
        }

        .submit-btn span {
            display: block;
        }

        .back-link {
            text-align: center;
            margin-top: 2rem;
        }

        .back-link a, .back-link button {
            color: #F8EAD7;
            opacity: 0.4;
            text-decoration: none;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: opacity 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }

        .back-link a:hover, .back-link button:hover {
            opacity: 0.8;
        }

        .error-msg {
            background: rgba(255, 80, 80, 0.15);
            color: #ff9999;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            margin-top: 1rem;
            display: none;
        }

        /* Payment summary */
        .summary-box {
            background: rgba(248, 234, 215, 0.06);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }

        .summary-row .label {
            opacity: 0.5;
        }

        .summary-total {
            border-top: 1px solid rgba(248, 234, 215, 0.15);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
        }

        /* Stripe Elements container */
        #payment-element {
            margin-bottom: 1rem;
        }

        /* Success state */
        .success-checkmark {
            width: 64px;
            height: 64px;
            border: 2px solid rgba(248, 234, 215, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 1.5rem;
        }

        .success-text {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3e0f15;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a class="logo" href="index.html">
            <img src="Viola_Burgundy.svg" alt="Viola">
        </a>

        <h1>Presentkort</h1>
        <p class="subtitle">Ge bort en upplevelse på Viola. Presentkortet skickas direkt till mottagarens e-post och är giltigt i två år.</p>

        <div class="steps">
            <div class="step-dot active" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
        </div>

        <!-- STEP 1: Gift card details -->
        <div class="step active" id="step-1">
            <form id="gift-card-form">
                <div>
                    <span class="amount-label">Välj belopp</span>
                    <div class="amount-grid">
                        <button type="button" class="amount-btn" data-amount="500">500 kr</button>
                        <button type="button" class="amount-btn" data-amount="1000">1 000 kr</button>
                        <button type="button" class="amount-btn" data-amount="1500">1 500 kr</button>
                        <button type="button" class="amount-btn" data-amount="2000">2 000 kr</button>
                    </div>
                    <input type="number" class="custom-amount-input" id="custom-amount" min="500" step="50" placeholder="Annat belopp (min 500 kr)">
                </div>

                <div class="section-divider">Mottagare</div>

                <div class="form-group">
                    <label for="recipient-name">Namn</label>
                    <input type="text" id="recipient-name" required placeholder="Mottagarens namn">
                </div>

                <div class="form-group">
                    <label for="recipient-email">E-post</label>
                    <input type="email" id="recipient-email" required placeholder="mottagare@email.se">
                </div>

                <div class="form-group">
                    <label for="message">Meddelande <span class="optional">(valfritt)</span></label>
                    <textarea id="message" placeholder="T.ex. Grattis på födelsedagen!"></textarea>
                </div>

                <div class="section-divider">Dina uppgifter</div>

                <div class="form-group">
                    <label for="buyer-name">Namn</label>
                    <input type="text" id="buyer-name" required placeholder="Ditt namn">
                </div>

                <div class="form-group">
                    <label for="buyer-email">E-post</label>
                    <input type="email" id="buyer-email" required placeholder="din@email.se">
                </div>

                <button type="submit" class="submit-btn"><span>Gå till betalning</span></button>
                <div class="error-msg" id="error-msg"></div>
            </form>

            <div class="back-link">
                <a href="index.html">&larr; Tillbaka till Viola</a>
            </div>
        </div>

        <!-- STEP 2: Payment -->
        <div class="step" id="step-2">
            <div class="summary-box">
                <div class="summary-row">
                    <span class="label">Presentkort</span>
                    <span id="summary-amount"></span>
                </div>
                <div class="summary-row">
                    <span class="label">Till</span>
                    <span id="summary-recipient"></span>
                </div>
                <div class="summary-row summary-total">
                    <span>Att betala</span>
                    <span id="summary-total"></span>
                </div>
            </div>

            <div class="section-divider">Betalning</div>

            <div id="payment-element"></div>

            <button type="button" class="submit-btn" id="pay-btn" disabled>
                <span id="pay-btn-text">Betala</span>
            </button>
            <div class="error-msg" id="payment-error"></div>

            <div class="back-link">
                <button type="button" id="back-to-details">&larr; Tillbaka</button>
            </div>
        </div>

        <!-- STEP 3: Confirmation -->
        <div class="step" id="step-3">
            <div class="success-checkmark">&#10003;</div>
            <h1 style="margin-bottom: 1rem;">Tack!</h1>
            <p class="success-text">Presentkortet skickas till mottagarens e-post inom kort.</p>
            <p class="success-text">En bekräftelse skickas även till din e-post.</p>

            <div class="back-link" style="margin-top: 3rem;">
                <a href="index.html">&larr; Tillbaka till Viola</a>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nssyzyjtmhlriyilgddf.supabase.co';

        let selectedAmount = null;
        let stripe = null;
        let elements = null;
        let formData = {};

        // --- Step management ---
        function goToStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active'));
            document.getElementById('step-' + n).classList.add('active');
            document.getElementById('dot-' + n).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Step 1: Amount selection ---
        const amountBtns = document.querySelectorAll('.amount-btn');
        const customInput = document.getElementById('custom-amount');

        amountBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                amountBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAmount = parseInt(btn.dataset.amount);
                customInput.value = '';
            });
        });

        customInput.addEventListener('input', () => {
            amountBtns.forEach(b => b.classList.remove('selected'));
            selectedAmount = parseInt(customInput.value) || null;
        });

        // --- Step 1 → Step 2: Create PaymentIntent ---
        document.getElementById('gift-card-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const errorEl = document.getElementById('error-msg');
            errorEl.style.display = 'none';

            if (!selectedAmount || selectedAmount < 500) {
                errorEl.textContent = 'Välj ett belopp (minst 500 kr).';
                errorEl.style.display = 'block';
                return;
            }

            const button = e.target.querySelector('.submit-btn');
            const buttonSpan = button.querySelector('span');
            const originalText = buttonSpan.textContent;

            formData = {
                amount: selectedAmount,
                buyer_name: document.getElementById('buyer-name').value,
                buyer_email: document.getElementById('buyer-email').value,
                recipient_name: document.getElementById('recipient-name').value,
                recipient_email: document.getElementById('recipient-email').value,
                message: document.getElementById('message').value,
            };

            try {
                buttonSpan.innerHTML = '<span class="spinner"></span>Laddar...';
                button.disabled = true;

                const response = await fetch(`${SUPABASE_URL}/functions/v1/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                const data = await response.json();

                if (!data.clientSecret) {
                    throw new Error(data.error || 'Kunde inte starta betalning');
                }

                // Initialize Stripe Elements
                stripe = Stripe(data.publishableKey);
                elements = stripe.elements({
                    clientSecret: data.clientSecret,
                    appearance: {
                        theme: 'night',
                        variables: {
                            colorPrimary: '#F8EAD7',
                            colorBackground: '#2a0a10',
                            colorText: '#F8EAD7',
                            colorDanger: '#ff8a8a',
                            fontFamily: 'Inter, sans-serif',
                            borderRadius: '0px',
                            colorTextPlaceholder: 'rgba(248, 234, 215, 0.4)',
                        },
                        rules: {
                            '.Input': {
                                backgroundColor: 'rgba(248, 234, 215, 0.1)',
                                border: 'none',
                            },
                            '.Tab': {
                                backgroundColor: 'transparent',
                                border: '1px solid rgba(248, 234, 215, 0.25)',
                            },
                            '.Tab--selected': {
                                backgroundColor: '#F8EAD7',
                                color: '#3e0f15',
                            },
                        },
                    },
                    locale: 'sv',
                });

                const paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

                paymentElement.on('ready', () => {
                    document.getElementById('pay-btn').disabled = false;
                });

                // Update summary
                document.getElementById('summary-amount').textContent = formData.amount + ' kr';
                document.getElementById('summary-recipient').textContent = formData.recipient_name;
                document.getElementById('summary-total').textContent = formData.amount + ' kr';
                document.getElementById('pay-btn-text').textContent = 'Betala ' + formData.amount + ' kr';

                goToStep(2);
            } catch (error) {
                console.error('Error:', error);
                errorEl.textContent = error.message || 'Något gick fel. Försök igen om en stund.';
                errorEl.style.display = 'block';
            } finally {
                buttonSpan.textContent = originalText;
                button.disabled = false;
            }
        });

        // --- Step 2: Confirm payment ---
        document.getElementById('pay-btn').addEventListener('click', async () => {
            const payBtn = document.getElementById('pay-btn');
            const payBtnText = document.getElementById('pay-btn-text');
            const payError = document.getElementById('payment-error');

            payBtn.disabled = true;
            payBtnText.innerHTML = '<span class="spinner"></span>Behandlar...';
            payError.style.display = 'none';

            const { error, paymentIntent } = await stripe.confirmPayment({
                elements,
                redirect: 'if_required',
            });

            if (error) {
                payError.textContent = error.message;
                payError.style.display = 'block';
                payBtn.disabled = false;
                payBtnText.textContent = 'Betala ' + formData.amount + ' kr';
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                goToStep(3);
            } else {
                // Payment requires additional action or redirect happened
                payBtn.disabled = false;
                payBtnText.textContent = 'Betala ' + formData.amount + ' kr';
            }
        });

        // --- Back button ---
        document.getElementById('back-to-details').addEventListener('click', () => {
            goToStep(1);
        });

        // --- Handle return from redirect-based payment methods ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment_intent_client_secret')) {
            goToStep(3);
        }
    </script>
</body>
</html>
