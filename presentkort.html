<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Presentkort - Restaurang Viola</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #3e0f15;
            color: #F8EAD7;
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .logo {
            display: block;
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo img {
            width: 140px;
            filter: brightness(0) invert(1) opacity(0.9);
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.7;
            line-height: 1.6;
            margin-bottom: 2.5rem;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(248, 234, 215, 0.2);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: #F8EAD7;
            width: 24px;
            border-radius: 4px;
        }

        /* Sections */
        .step { display: none; }
        .step.active { display: block; }

        .amount-label {
            display: block;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .amount-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .amount-btn {
            padding: 1rem;
            border: 1px solid rgba(248, 234, 215, 0.25);
            background: transparent;
            color: #F8EAD7;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .amount-btn:hover {
            border-color: #F8EAD7;
            background: rgba(248, 234, 215, 0.08);
        }

        .amount-btn.selected {
            background: #F8EAD7;
            color: #3e0f15;
            border-color: #F8EAD7;
        }

        .custom-amount-input {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 1px solid rgba(248, 234, 215, 0.25);
            background: transparent;
            color: #F8EAD7;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            text-align: center;
            margin-top: 0.5rem;
        }

        .custom-amount-input::placeholder {
            color: rgba(248, 234, 215, 0.4);
        }

        .custom-amount-input:focus {
            outline: none;
            border-color: #F8EAD7;
        }

        .section-divider {
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            font-size: 0.7rem;
            opacity: 0.4;
            margin: 2rem 0 1rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        label {
            display: block;
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            font-size: 0.8rem;
        }

        label .optional {
            opacity: 0.4;
            text-transform: none;
            letter-spacing: normal;
            font-size: 0.75rem;
        }

        input, textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: none;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: rgba(248, 234, 215, 0.1);
            color: #F8EAD7;
        }

        input:focus, textarea:focus {
            outline: none;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(248, 234, 215, 0.4);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            background: #F8EAD7;
            color: #3e0f15;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.15em;
            margin-top: 1.5rem;
            transition: background-color 0.2s;
        }

        .submit-btn:hover:not(:disabled) {
            background: #ffffff;
        }

        .submit-btn:disabled {
            cursor: default;
            opacity: 0.7;
        }

        .submit-btn span {
            display: block;
        }

        .back-link {
            text-align: center;
            margin-top: 2rem;
        }

        .back-link a, .back-link button {
            color: #F8EAD7;
            opacity: 0.4;
            text-decoration: none;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: opacity 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }

        .back-link a:hover, .back-link button:hover {
            opacity: 0.8;
        }

        .error-msg {
            background: rgba(255, 80, 80, 0.15);
            color: #ff9999;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            margin-top: 1rem;
            display: none;
        }

        /* Payment summary */
        .summary-box {
            background: rgba(248, 234, 215, 0.06);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }

        .summary-row .label {
            opacity: 0.5;
        }

        .summary-total {
            border-top: 1px solid rgba(248, 234, 215, 0.15);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
        }

        /* Stripe Elements container */
        #payment-element {
            margin-bottom: 1rem;
        }

        /* Hide Klarna's misleading "Pay full amount" message */
        #payment-element .p-MessageText,
        #payment-element [class*="Message"],
        #payment-element .p-PaymentMethodMessagingSection {
            display: none !important;
        }

        /* Success state */
        .success-checkmark {
            width: 64px;
            height: 64px;
            border: 2px solid rgba(248, 234, 215, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 1.5rem;
        }

        .success-text {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        /* Coupon */
        .coupon-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .coupon-row input {
            flex: 1;
            text-transform: uppercase;
        }

        .coupon-row button {
            padding: 0.8rem 1.2rem;
            border: 1px solid rgba(248, 234, 215, 0.25);
            background: transparent;
            color: #F8EAD7;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .coupon-row button:hover:not(:disabled) {
            border-color: #F8EAD7;
            background: rgba(248, 234, 215, 0.08);
        }

        .coupon-row button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .coupon-feedback {
            font-size: 0.8rem;
            margin-top: 0.4rem;
        }

        .coupon-feedback.success {
            color: #81c784;
        }

        .coupon-feedback.error {
            color: #ff9999;
        }

        .summary-row.discount .label,
        .summary-row.discount span:last-child {
            color: #81c784;
            opacity: 1;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3e0f15;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a class="logo" href="index.html">
            <img src="Viola_Burgundy.svg" alt="Viola">
        </a>

        <h1>Presentkort</h1>
        <p class="subtitle">Ge bort en upplevelse p√• Viola. Presentkortet skickas direkt till mottagarens e-post och √§r giltigt i tv√• √•r.</p>

        <div class="steps">
            <div class="step-dot active" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
        </div>

        <!-- STEP 1: Gift card details -->
        <div class="step active" id="step-1">
            <form id="gift-card-form">
                <div>
                    <span class="amount-label">V√§lj belopp</span>
                    <div class="amount-grid">
                        <button type="button" class="amount-btn" data-amount="500">500 kr</button>
                        <button type="button" class="amount-btn" data-amount="1000">1 000 kr</button>
                        <button type="button" class="amount-btn" data-amount="1500">1 500 kr</button>
                        <button type="button" class="amount-btn" data-amount="2000">2 000 kr</button>
                    </div>
                    <input type="number" class="custom-amount-input" id="custom-amount" min="500" max="10000" step="50" placeholder="Annat belopp (500 ‚Äì 10 000 kr)">
                </div>

                <div class="section-divider">Mottagare</div>

                <div class="form-group">
                    <label for="recipient-name">Namn</label>
                    <input type="text" id="recipient-name" required placeholder="Mottagarens namn">
                </div>

                <div class="form-group">
                    <label for="recipient-email">E-post</label>
                    <input type="email" id="recipient-email" required placeholder="mottagare@email.se">
                </div>

                <div class="form-group">
                    <label for="message">Meddelande <span class="optional">(valfritt)</span></label>
                    <textarea id="message" maxlength="200" placeholder="T.ex. Grattis p√• f√∂delsedagen! (max 200 tecken, 4 rader)"></textarea>
                    <div style="font-size: 0.7rem; opacity: 0.5; margin-top: 0.3rem;" id="message-counter">0/200 tecken, 0/4 rader</div>
                </div>

                <div class="section-divider">Dina uppgifter</div>

                <div class="form-group">
                    <label for="buyer-name">Namn</label>
                    <input type="text" id="buyer-name" required placeholder="Ditt namn">
                </div>

                <div class="form-group">
                    <label for="buyer-email">E-post</label>
                    <input type="email" id="buyer-email" required placeholder="din@email.se">
                </div>

                <div class="section-divider">Kupongkod</div>

                <div class="coupon-row">
                    <input type="text" id="coupon-code" placeholder="Ange kupongkod">
                    <button type="button" id="apply-coupon">Till√§mpa</button>
                </div>
                <div class="coupon-feedback" id="coupon-feedback"></div>

                <button type="submit" class="submit-btn"><span>G√• till betalning</span></button>
                <div class="error-msg" id="error-msg"></div>
            </form>

            <div class="back-link">
                <a href="index.html">&larr; Tillbaka till Viola</a>
            </div>
        </div>

        <!-- STEP 2: Payment -->
        <div class="step" id="step-2">
            <div class="summary-box">
                <div class="summary-row">
                    <span class="label">Presentkort</span>
                    <span id="summary-amount"></span>
                </div>
                <div class="summary-row">
                    <span class="label">Till</span>
                    <span id="summary-recipient"></span>
                </div>
                <div class="summary-row discount" id="summary-discount-row" style="display:none;">
                    <span class="label" id="summary-discount-label"></span>
                    <span id="summary-discount"></span>
                </div>
                <div class="summary-row summary-total">
                    <span>Att betala</span>
                    <span id="summary-total"></span>
                </div>
            </div>

            <div class="section-divider">Betalning</div>

            <div id="klarna-info" style="display: none; background: rgba(190, 175, 151, 0.15); border: 1px solid rgba(190, 175, 151, 0.5); padding: 1rem 1.25rem; margin-bottom: 1.25rem; font-size: 0.85rem; line-height: 1.6; border-radius: 4px; border-left: 3px solid #BEAF97;">
                <div style="font-weight: 600; margin-bottom: 0.25rem; color: #BEAF97;">üí≥ Klarna - Betala hela beloppet eller delbetala</div>
                <div style="opacity: 0.9;">I n√§sta steg v√§ljer du mellan direktbetalning, betala senare (30 dagar) eller dela upp betalningen.</div>
            </div>

            <div id="payment-element"></div>

            <button type="button" class="submit-btn" id="pay-btn" disabled>
                <span id="pay-btn-text">Betala</span>
            </button>
            <div class="error-msg" id="payment-error"></div>

            <div class="back-link">
                <button type="button" id="back-to-details">&larr; Tillbaka</button>
            </div>
        </div>

        <!-- STEP 3: Confirmation -->
        <div class="step" id="step-3">
            <div class="success-checkmark">&#10003;</div>
            <h1 style="margin-bottom: 1rem;">Tack!</h1>
            <p class="success-text">Presentkortet skickas till mottagarens e-post inom kort.</p>
            <p class="success-text">En bekr√§ftelse skickas √§ven till din e-post.</p>

            <div class="back-link" style="margin-top: 3rem;">
                <a href="index.html">&larr; Tillbaka till Viola</a>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nssyzyjtmhlriyilgddf.supabase.co';

        let selectedAmount = null;
        let stripe = null;
        let elements = null;
        let formData = {};
        let appliedCoupon = null; // { code, percent_off, amount_off, name }

        // Update payment summary display
        function updateSummary() {
            document.getElementById('summary-amount').textContent = formData.amount + ' kr';
            document.getElementById('summary-recipient').textContent = formData.recipient_name;

            const savedDiscount = sessionStorage.getItem('giftcard_discount');
            if (savedDiscount) {
                const discount = JSON.parse(savedDiscount);
                document.getElementById('summary-discount-row').style.display = 'flex';
                document.getElementById('summary-discount-label').textContent = discount.label;
                document.getElementById('summary-discount').textContent = '-' + discount.savings + ' kr';
            } else {
                document.getElementById('summary-discount-row').style.display = 'none';
            }

            const chargeAmount = formData.chargeAmount || formData.amount;
            document.getElementById('summary-total').textContent = chargeAmount + ' kr';
            document.getElementById('pay-btn-text').textContent = 'Betala ' + chargeAmount + ' kr';
        }

        // Setup payment element event listeners
        function setupPaymentElementListeners(paymentElement) {
            paymentElement.on('ready', () => {
                document.getElementById('pay-btn').disabled = false;

                // Try to update Klarna messaging text
                setTimeout(() => {
                    const paymentElement = document.getElementById('payment-element');
                    if (paymentElement) {
                        const iframe = paymentElement.querySelector('iframe');
                        // Note: Can't access iframe content due to cross-origin restrictions
                        // Fallback: info box above already explains installment options
                    }
                }, 500);
            });

            // Update button text and info box based on selected payment method
            paymentElement.on('change', (event) => {
                const payBtnText = document.getElementById('pay-btn-text');
                const klarnaInfo = document.getElementById('klarna-info');
                const chargeAmount = formData.chargeAmount || formData.amount;

                if (event.value?.type === 'klarna') {
                    payBtnText.textContent = 'Forts√§tt till Klarna - ' + chargeAmount + ' kr';
                    if (klarnaInfo) klarnaInfo.style.display = 'block';
                } else {
                    payBtnText.textContent = 'Betala ' + chargeAmount + ' kr';
                    if (klarnaInfo) klarnaInfo.style.display = 'none';
                }
            });
        }

        // --- Step management ---
        function goToStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active'));
            document.getElementById('step-' + n).classList.add('active');
            document.getElementById('dot-' + n).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Step 1: Amount selection ---
        const amountBtns = document.querySelectorAll('.amount-btn');
        const customInput = document.getElementById('custom-amount');

        amountBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                amountBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAmount = parseInt(btn.dataset.amount);
                customInput.value = '';
            });
        });

        customInput.addEventListener('input', () => {
            amountBtns.forEach(b => b.classList.remove('selected'));
            selectedAmount = parseInt(customInput.value) || null;
        });

        // --- Coupon validation ---
        document.getElementById('apply-coupon').addEventListener('click', async () => {
            const couponInput = document.getElementById('coupon-code');
            const feedback = document.getElementById('coupon-feedback');
            const btn = document.getElementById('apply-coupon');
            const code = couponInput.value.trim().toUpperCase();

            if (!code) {
                feedback.textContent = 'Ange en kupongkod.';
                feedback.className = 'coupon-feedback error';
                return;
            }

            btn.disabled = true;
            btn.textContent = '...';
            feedback.textContent = '';

            try {
                const res = await fetch(`${SUPABASE_URL}/functions/v1/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ validate_coupon: code }),
                });
                const data = await res.json();

                if (data.valid) {
                    appliedCoupon = data;
                    const desc = data.percent_off
                        ? data.percent_off + '% rabatt'
                        : data.amount_off + ' kr rabatt';
                    feedback.textContent = (data.name || code) + ' ‚Äî ' + desc;
                    feedback.className = 'coupon-feedback success';
                    couponInput.disabled = true;
                    btn.textContent = '\u2713';
                } else {
                    appliedCoupon = null;
                    feedback.textContent = data.error || 'Ogiltig kupongkod.';
                    feedback.className = 'coupon-feedback error';
                    btn.textContent = 'Till√§mpa';
                }
            } catch (err) {
                feedback.textContent = 'Kunde inte validera koden.';
                feedback.className = 'coupon-feedback error';
                btn.textContent = 'Till√§mpa';
            }
            btn.disabled = false;
        });

        // --- Step 1 ‚Üí Step 2: Create PaymentIntent ---
        document.getElementById('gift-card-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const errorEl = document.getElementById('error-msg');
            errorEl.style.display = 'none';

            if (!selectedAmount || selectedAmount < 500) {
                errorEl.textContent = 'V√§lj ett belopp (minst 500 kr).';
                errorEl.style.display = 'block';
                return;
            }

            if (selectedAmount > 10000) {
                errorEl.textContent = 'Maxbelopp √§r 10 000 kr.';
                errorEl.style.display = 'block';
                return;
            }

            const message = document.getElementById('message').value;
            const lineCount = message.trim() ? message.split('\n').length : 0;
            if (lineCount > 4) {
                errorEl.textContent = 'Meddelandet kan max vara 4 rader.';
                errorEl.style.display = 'block';
                return;
            }

            const button = e.target.querySelector('.submit-btn');
            const buttonSpan = button.querySelector('span');
            const originalText = buttonSpan.textContent;

            formData = {
                amount: selectedAmount,
                buyer_name: document.getElementById('buyer-name').value,
                buyer_email: document.getElementById('buyer-email').value,
                recipient_name: document.getElementById('recipient-name').value,
                recipient_email: document.getElementById('recipient-email').value,
                message: document.getElementById('message').value,
                coupon_code: appliedCoupon ? appliedCoupon.code : undefined,
            };

            // Save form data to sessionStorage for redirect recovery
            sessionStorage.setItem('giftcard_formdata', JSON.stringify(formData));
            if (appliedCoupon) {
                sessionStorage.setItem('giftcard_coupon', JSON.stringify(appliedCoupon));
            }

            try {
                buttonSpan.innerHTML = '<span class="spinner"></span>Laddar...';
                button.disabled = true;

                const response = await fetch(`${SUPABASE_URL}/functions/v1/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                const data = await response.json();

                if (!data.clientSecret) {
                    throw new Error(data.error || 'Kunde inte starta betalning');
                }

                // Initialize Stripe Elements
                stripe = Stripe(data.publishableKey);
                elements = stripe.elements({
                    clientSecret: data.clientSecret,
                    appearance: {
                        theme: 'night',
                        variables: {
                            colorPrimary: '#F8EAD7',
                            colorBackground: '#2a0a10',
                            colorText: '#F8EAD7',
                            colorDanger: '#ff8a8a',
                            fontFamily: 'Inter, sans-serif',
                            borderRadius: '0px',
                            colorTextPlaceholder: 'rgba(248, 234, 215, 0.4)',
                        },
                        rules: {
                            '.Input': {
                                backgroundColor: 'rgba(248, 234, 215, 0.1)',
                                border: 'none',
                            },
                            '.Tab': {
                                backgroundColor: 'transparent',
                                border: '1px solid rgba(248, 234, 215, 0.25)',
                            },
                            '.Tab--selected': {
                                backgroundColor: '#F8EAD7',
                                color: '#3e0f15',
                            },
                        },
                    },
                    locale: 'sv',
                });

                const paymentElement = elements.create('payment', {
                    layout: {
                        type: 'tabs',
                        defaultCollapsed: false,
                    },
                    wallets: {
                        applePay: 'auto',
                        googlePay: 'auto',
                    },
                    paymentMethodOrder: ['card', 'klarna', 'link'],
                });
                paymentElement.mount('#payment-element');

                // Setup event listeners
                setupPaymentElementListeners(paymentElement);

                // Update summary
                document.getElementById('summary-amount').textContent = formData.amount + ' kr';
                document.getElementById('summary-recipient').textContent = formData.recipient_name;

                const chargeAmount = data.chargeAmount || formData.amount;
                formData.chargeAmount = chargeAmount;

                // Save payment data for redirect recovery
                sessionStorage.setItem('giftcard_charge', chargeAmount.toString());
                sessionStorage.setItem('giftcard_publishable_key', data.publishableKey);
                if (data.discount) {
                    sessionStorage.setItem('giftcard_discount', JSON.stringify(data.discount));
                }

                // Update summary
                updateSummary();

                goToStep(2);
            } catch (error) {
                console.error('Error:', error);
                errorEl.textContent = error.message || 'N√•got gick fel. F√∂rs√∂k igen om en stund.';
                errorEl.style.display = 'block';
            } finally {
                buttonSpan.textContent = originalText;
                button.disabled = false;
            }
        });

        // --- Step 2: Confirm payment ---
        document.getElementById('pay-btn').addEventListener('click', async () => {
            const payBtn = document.getElementById('pay-btn');
            const payBtnText = document.getElementById('pay-btn-text');
            const payError = document.getElementById('payment-error');

            payBtn.disabled = true;
            payBtnText.innerHTML = '<span class="spinner"></span>Behandlar...';
            payError.style.display = 'none';

            // Build confirmPayment params
            const confirmParams = {};

            // Only add return_url for production (Stripe doesn't accept localhost)
            const isLocalhost = window.location.hostname === 'localhost' ||
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname === '';

            if (!isLocalhost) {
                confirmParams.return_url = window.location.origin + '/presentkort.html?payment_success=true';
            }

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: Object.keys(confirmParams).length > 0 ? confirmParams : undefined,
                redirect: isLocalhost ? 'if_required' : undefined,
            });

            if (error) {
                // Payment failed or was cancelled
                payError.textContent = error.message;
                payError.style.display = 'block';
                payBtn.disabled = false;
                payBtnText.textContent = 'Betala ' + (formData.chargeAmount || formData.amount) + ' kr';
            } else {
                // Payment succeeded (for non-redirect methods like cards)
                // For redirect methods (Klarna), the page will redirect automatically
                goToStep(3);
            }
        });

        // --- Back button ---
        document.getElementById('back-to-details').addEventListener('click', () => {
            goToStep(1);
        });

        // --- Handle return from redirect-based payment methods ---
        const urlParams = new URLSearchParams(window.location.search);
        const redirectStatus = urlParams.get('redirect_status');
        const clientSecret = urlParams.get('payment_intent_client_secret');

        if (redirectStatus === 'succeeded') {
            // Payment succeeded, show success page
            sessionStorage.clear();
            goToStep(3);
        } else if (redirectStatus === 'failed' && clientSecret) {
            // Payment failed or was cancelled, restore session and show payment page
            const savedFormData = sessionStorage.getItem('giftcard_formdata');
            const savedCoupon = sessionStorage.getItem('giftcard_coupon');
            const savedCharge = sessionStorage.getItem('giftcard_charge');
            const publishableKey = sessionStorage.getItem('giftcard_publishable_key');

            if (savedFormData && publishableKey) {
                formData = JSON.parse(savedFormData);
                formData.chargeAmount = savedCharge ? parseInt(savedCharge) : formData.amount;

                if (savedCoupon) {
                    appliedCoupon = JSON.parse(savedCoupon);
                }

                // Re-initialize Stripe Elements with existing PaymentIntent
                stripe = Stripe(publishableKey);
                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'night',
                        variables: {
                            colorPrimary: '#F8EAD7',
                            colorBackground: '#2a0a10',
                            colorText: '#F8EAD7',
                            colorDanger: '#ff8a8a',
                            fontFamily: 'Inter, sans-serif',
                            borderRadius: '0px',
                            colorTextPlaceholder: 'rgba(248, 234, 215, 0.4)',
                        },
                        rules: {
                            '.Input': {
                                backgroundColor: 'rgba(248, 234, 215, 0.1)',
                                border: 'none',
                            },
                            '.Tab': {
                                backgroundColor: 'transparent',
                                border: '1px solid rgba(248, 234, 215, 0.25)',
                            },
                            '.Tab--selected': {
                                backgroundColor: '#F8EAD7',
                                color: '#3e0f15',
                            },
                        },
                    },
                    locale: 'sv',
                });

                const paymentElement = elements.create('payment', {
                    layout: {
                        type: 'tabs',
                        defaultCollapsed: false,
                    },
                    wallets: {
                        applePay: 'auto',
                        googlePay: 'auto',
                    },
                    paymentMethodOrder: ['card', 'klarna', 'link'],
                });
                paymentElement.mount('#payment-element');

                // Setup event listeners
                setupPaymentElementListeners(paymentElement);

                // Update summary
                updateSummary();

                // Show payment page with error
                goToStep(2);
                const paymentError = document.getElementById('payment-error');
                paymentError.textContent = 'Betalningen avbr√∂ts eller misslyckades. V√§lj en annan betalmetod eller f√∂rs√∂k igen.';
                paymentError.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // --- Message character and line counter ---
        const messageTextarea = document.getElementById('message');
        const messageCounter = document.getElementById('message-counter');

        function updateMessageCounter() {
            const text = messageTextarea.value;
            const charCount = text.length;
            const lineCount = text.trim() ? text.split('\n').length : 0;
            const counterText = `${charCount}/200 tecken, ${lineCount}/4 rader`;

            if (lineCount > 4) {
                messageCounter.style.color = '#ef9a9a';
                messageCounter.textContent = counterText + ' (f√∂r m√•nga rader!)';
            } else {
                messageCounter.style.color = '';
                messageCounter.textContent = counterText;
            }
        }

        messageTextarea.addEventListener('input', updateMessageCounter);
        updateMessageCounter();
    </script>
</body>
</html>
